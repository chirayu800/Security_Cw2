# Audit & Internal Penetration Testing (PoC + Remediation)

Use this document for your **report + video demo**.

## What to demonstrate in the video

- **RBAC / route protection**
  - Show that admin-only endpoints return **403** for a normal user token.
- **Secure session**
  - Show browser DevTools → Application → Cookies:
    - `access_token` is **httpOnly**
    - session expires (1 hour)
  - Show logout clears cookies and invalidates session.
- **Encryption at rest**
  - Show MongoDB Compass:
    - `password` is **bcrypt hashed**
    - `email`/`name` are **AES encrypted**
    - `emailHash` is visible and used for lookup
- **Audit logs**
  - Show audit log entries for login success/failure and admin actions.
- **HTTPS**
  - Show backend running with `server-https.js` and requests over `https://localhost:4443`.

## Internal audit checklist (quick)

- **Dependency audit**
  - Backend:
    - `cd backend`
    - `npm audit`
  - Frontend:
    - `cd frontend`
    - `npm audit`
  - Admin:
    - `cd admin`
    - `npm audit`

- **Secrets check**
  - Ensure `.env` files are not committed publicly
  - Rotate any keys that were ever exposed

## Proof-of-Concept (PoC) vulnerabilities + remediation

### PoC 1: IDOR (Insecure Direct Object Reference) – Cart

- **Before fix**
  - Attacker could send a different `userId` in cart requests and access/modify another user’s cart.
- **Fix implemented**
  - Backend now uses the authenticated `req.userId` and rejects mismatches.
  - Code: `backend/controllers/cartController.js`

### PoC 2: Admin auth bypass (role not enforced)

- **Before fix**
  - `adminAuth` could allow any valid JWT token to pass, which means a normal user token might access admin routes.
- **Fix implemented**
  - Admin middleware now requires `role: "admin"` and validates admin email against DB/env.
  - Code: `backend/middleware/adminAuth.js`

### PoC 3: CSRF on cookie-based auth

- **Risk**
  - When auth uses cookies, a malicious site can trigger state-changing requests from the victim’s browser.
- **Fix implemented**
  - Double-submit CSRF protection:
    - cookie: `csrf_token`
    - header: `x-csrf-token`
  - Code:
    - `backend/middleware/csrfProtection.js`
    - `frontend/src/api/api.js`
    - `admin/src/api/api.js`

### PoC 4: Token theft via XSS (common MERN issue)

- **Risk**
  - If tokens are stored in `localStorage`, XSS can steal them.
- **Mitigation implemented**
  - Backend now supports **httpOnly cookie session** (`access_token`) which is not readable by JS.
- **Recommended next hardening**
  - Stop relying on `localStorage` for auth state (use a `/me` endpoint + in-memory state).

### PoC 5: Brute force / credential stuffing

- **Risk**
  - Repeated login attempts can guess passwords.
- **Recommended remediation**
  - Add rate limiting (e.g. per-IP and per-account), account lockout policies, and monitoring.
  - Consider adding `express-rate-limit` + logging lockouts in audit logs.

## Tools you can mention (optional)

- OWASP ZAP baseline scan (local)
- Burp Suite Community (manual testing)
- Postman / Insomnia (API testing)

